<!--
	This work was developed for the discipline of 
		Artificial Intelligence of the 4th year of 
		Information Systems in Univille - University of Joinville Region.
		
	Developers:
		@andreirosseti (Andrei Rosseti, andrei@rosseti.eti.br)
		@diogocidral (Diogo Z. Cidral, diogo.cidral@gmail.com)
		
-->
<!DOCTYPE HTML>
<html>
<head>
	<title>The Trollers Game - Dama game written in HTML5 language</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<script>
 
	var DEBUG = true;
	var DRAW_INTERVAL = 100;

	var AREA_WIDTH = 50;
	var AREA_HEIGHT = 50;

	var PIECE_PADDING = 5;

	var canvas;	// my canvas object
	var ctx;	// context
	var pieces = []; // pieces array

	var areas = [];
	
	function disableSelection(target)
	{
		if (typeof target.onselectstart!="undefined") //IE route
			target.onselectstart=function(){return false}
		else if (typeof target.style.MozUserSelect!="undefined") //Firefox route
			target.style.MozUserSelect="none"
		else //All other route (ie: Opera)
			target.onmousedown=function(){return false}
	}
	
	function debug(message)
	{
		if (DEBUG) 
		{
			var m = "<div class='message'>"+ message + '</div>';
			document.getElementById('debugMessages').innerHTML += m;
		}
		
		document.getElementById('debugMessages').scrollTop = document.getElementById('debugMessages').scrollHeight;
	}

	function Shot()
	{
		this.validate = function(fromCell, toCell) 
		{
			// verificar se a jogada está na diagonal
			var area = findAreaByPosition(toCell);
			
			if (area != null) 
			{
				if (!player1.hasPieceAtCell(toCell) && !player2.hasPieceAtCell(toCell)) 
				{
					var shotType = Math.abs(toCell.column - fromCell.column);
					
					if (shotType == 1) 
					{
						// normal move
						player1.movePiece(fromCell, toCell);
					} else if (shotType == 2) 
					{
						// eat piece
						var minus 		= (toCell.column - fromCell.column) == -2 ? -1 : 1;
						var targetCell 	= new Cell(toCell.row - 1, fromCell.column + minus);
						
						if (player2.hasPieceAtCell(targetCell)) {
							// compute point to player 1
							player1.movePiece(fromCell, toCell);
							player1.increasePoint();
							player2.removePieceAtCell(targetCell);
							debug('P1 got the point');
						} else {
							debug('ops... invalid shot! try again');
						}
						
					}
					
				} else {
					debug('ops... area contais one piece at place.');
				}
				
			} else {
				debug('ops... invalid area.');
			}
		}
	}

	function Player(name, pieces, color, cpu) 
	{
		if (cpu == undefined) {
			cpu = false;
		}
		
		this.name = name;
		this.id	  = this.name.replace(" ", "_");
		this.pieces = pieces; // player cell pointer
		this.cpu = cpu;
		this.color = color;
		this.pts = 0;
		
		this.initialize = function () 
		{	
			
			// adiciona as informações do usuário numa box...
			var user_type = this.cpu ? "CPU" : "User";
			document.getElementById('userinfo').innerHTML += "<div id='"+this.id+"' class='ublock'><div class='box' style='background-color: "+this.color+"'></div><strong>"+user_type+": </strong>"+this.name+" <br /><div class='ptsinfo'>Pontuação: <span class='pts'>0</span></div></div>";
			
			debug('Initializing new player with name: <strong>' + this.name + '</strong>');
		};
		
		this.hasPieceAtCell = function (cell) 
		{
			for (var i in this.pieces) 
			{
				if (this.pieces[i].isEqual(cell)) {
					return true;
				}
			}
			
			return false;
		};
		
		this.removePieceAtCell = function (cell)
		{
			for (var i in this.pieces) 
			{
				if (this.pieces[i].isEqual(cell)) {
					//this.pieces[i] = null;
					this.pieces.splice(i, 1);
				}
			}
		}
		
		this.increasePoint = function () 
		{
			this.pts++;
			var pts = document.getElementById(this.id).getElementsByClassName('pts');
			pts[0].innerHTML = this.pts;
		};
		
		this.drawPieces = function () 
		{
			for (var i in this.pieces) 
			{	
				var radius = 20;
				ctx.strokeStyle = "#000000";
				ctx.fillStyle = this.color; 
				ctx.beginPath();
				ctx.arc(this.pieces[i].column * AREA_WIDTH + radius + PIECE_PADDING, this.pieces[i].row * AREA_HEIGHT + radius + PIECE_PADDING, radius, 0, Math.PI*2, true);
				ctx.closePath();
				ctx.stroke();
				ctx.fill();
			}
		};
		
		this.drawGhostPiece = function (cell) 
		{
			var radius = 20;
			ctx.strokeStyle = "#000000";
			ctx.fillStyle = this.color; 
			ctx.beginPath();
			ctx.arc(cell.column, cell.row, radius, 0, Math.PI*2, true);
			ctx.closePath();
			ctx.stroke();
			ctx.fill();
		}
		
		this.movePiece = function (fromCell, toCell) 
		{
			for (var i in this.pieces) 
			{
				if (this.pieces[i].isEqual(fromCell)) {
					this.pieces[i] = toCell;
				}
			}
			
			return null;
		};
	}

	function Cell(row, column) 
	{
	    this.row = row;
	    this.column = column;
	
		this.toString = function () 
		{
			return "[column: "+this.column+", row: "+this.row+"]";
		}
		
		this.isEqual = function (cell) {
			if (this.row == cell.row && this.column == cell.column) {
				return true;
			}
			
			return false;
		}
	}

	function Area() 
	{
		this.column = 0;
		this.row = 0;
		this.playable = false;
		
		this.draw = function () 
		{
			if (this.playable) 
			{
				ctx.fillStyle = '#D18B47'; 
			} else {
				ctx.fillStyle = '#FFCE9E';
			}
			
			ctx.beginPath();
			ctx.fillRect(this.column * AREA_WIDTH, this.row * AREA_HEIGHT, AREA_WIDTH, AREA_HEIGHT);
			ctx.closePath();
			ctx.stroke();
			ctx.fill();
		}
	}

	function addArea(cell, playable) 
	{
		var area = new Area;
		area.column = cell.column;
		area.row = cell.row;
		area.playable = playable;
		areas.push(area);
	}
	
	function findAreaByPosition(cell) 
	{
		for (var i in areas) {
			var area = areas[i];
			if (area.playable && area.column == cell.column && area.row == cell.row) 
			{
				return area;
			}
		}
		
		return null;
	}

	// player 1 information
	var piecesArr = [ new Cell(0, 1), new Cell(0, 3), new Cell(0, 5), new Cell(0, 7), new Cell(1, 0), new Cell(1, 2), new Cell(1, 4), new Cell(1, 6), new Cell(2, 1), new Cell(2, 3), new Cell(2, 5), new Cell(2, 7)];
	var player1 = new Player("Andrei Rosseti", piecesArr, '#AF0000');
	//
	
	// player 2 information
	// var piecesArr = [ new Cell(5, 0), new Cell(5, 2), new Cell(5, 4), new Cell(5, 6), new Cell(6, 1), new Cell(6, 3), new Cell(6, 5), new Cell(6, 7), new Cell(7, 0), new Cell(7, 2), new Cell(7, 4), new Cell(7, 6)];
	var piecesArr = [ new Cell(3, 2), new Cell(5, 2), new Cell(5, 4), new Cell(5, 6), new Cell(6, 1), new Cell(6, 3), new Cell(6, 5), new Cell(6, 7), new Cell(7, 0), new Cell(7, 2), new Cell(7, 4), new Cell(7, 6)];
	var player2 = new Player("THOR", piecesArr, '#F4F2C4', true);
	//

	window.onload = function() 
	{
		canvas	= document.getElementById("canvas");
		ctx		= canvas.getContext("2d");

		canvas.addEventListener("mousedown", 	canvasDownHandler, false);
		canvas.addEventListener("mousemove",	canvasMouseMoveHandler, false);
		canvas.addEventListener("mouseout",		canvasMouseOutHandler, false);
		disableSelection(document.body);
		
		for (var row = 0; row < 8; row++) 
		{
			for (var column = 0; column < 8; column++) 
			{
				var playable = false;
				
				if (((column+row) % 2) == 1) {
					playable = true;
				}
			
				addArea(new Cell(row, column), playable);
			}
		}
		
		player1.initialize();
		player2.initialize();
		
		setInterval("Main.drawloop()", DRAW_INTERVAL);
	}

	Main = 
	{
		drawloop: function () 
		{
			for (var i in areas) {
				areas[i].draw();
			}
		
			player1.drawPieces();
			player2.drawPieces();
			
		}
	
	}
	
	var is_dragging = false;
	var last_used_piece = null;
	
	canvasDownHandler = function(e) {
		var cell = canvasGetMousePosition(e);
		var area;
		var piece;
		
		if (player1.hasPieceAtCell(cell))
		{
			last_used_piece = cell;
			canvas.addEventListener("mousemove",	canvasMovePieceHandler, false);
			canvas.addEventListener("mouseup",		canvasUpPieceHandler, false);
			
			debug('Found piece at cell object: ' + cell.toString());
			debug('Start dragging event');
			is_dragging = true;
		}
	}
	
	canvasMovePieceHandler = function (e) 
	{
		if (is_dragging) 
		{
			var cell = canvasGetMousePosition(e, false);
			player1.drawGhostPiece(cell);
		}
	}
	
	canvasUpPieceHandler = function (e) 
	{
		var shot = new Shot();
		var toCell 	= canvasGetMousePosition(e);
		var fromCell= last_used_piece;
		
		shot.validate(fromCell, toCell);
		
		//player1.movePiece(last_used_piece, cell);
		debug('Ending drag event');
		canvas.addEventListener("mousemove",	canvasMouseMoveHandler, false);
		canvas.removeEventListener("mouseup");
		
		document.body.style.cursor = "default";
		is_dragging = false;
	}
	
	canvasMouseOutHandler = function(e) {
		document.body.style.cursor = "default"; 
	}
	
	canvasMouseMoveHandler = function(e) 
	{
		var cell = canvasGetMousePosition(e);
		var area;
		var piece;
		
		if (player1.hasPieceAtCell(cell))
		{
			document.body.style.cursor = "pointer";
		} else {
			setTimeout(function () {
				document.body.style.cursor = "default"; 
			}, 100);
		}
	}
	
	canvasGetMousePosition = function(e, withCell) 
	{
		var canvas = document.getElementById('canvas');
		var x;
		var y;
		var cell;
		
		if (withCell == undefined) withCell = true;

		if (e.pageX != undefined && e.pageY != undefined) 
		{
			x = e.pageX;
			y = e.pageY;
		}
		else 
		{
			x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
			y = e.clientY + document.body.scrollTop	 + document.documentElement.scrollTop;
		}
		
		x -= canvas.offsetLeft;
		y -= canvas.offsetTop;
		
		if (withCell) {
			cell = new Cell(Math.floor(y/AREA_HEIGHT), Math.floor(x/AREA_WIDTH));
		} else {
			cell = new Cell(Math.floor(y), Math.floor(x));
		}
		
		return cell;
	}
 
	</script>
	<style type="text/css">
		body { font-family: "lucida grande", "arial"; font-size: 12px; cursor: default; }
		h1 { font-family: "lucida grande", "arial"; font-size: 28px; }
		h1 small { font-size: 12px; color: #888; font-weight: normal; display: block; }
		
		#debug 
		{ 
			position: fixed;
			top: 10px; right: 10px;
			width: 300px; height: 400px;
			border-radius: 10px; padding: 10px;
			background-color: #f4f4f4; border: 1px solid #ccc;
		}
		
		#debug #debugMessages {
			overflow-y: auto;
			width: 300px;
			height: 350px;
		}
		
		#main { width: 600px; margin: 0 auto; background: url('trollface.png') no-repeat top 280px; overflow: hidden; }
		.box { width: 26px; height: 26px; float: left; margin: 0 5px; border: 1px solid #444;	}
		#canvas { float: left; 	}
		#userinfo {
			float: left;
			margin-left: 5px;
		}
		#userinfo .ublock { overflow: hidden; margin: 5px 0; }
		#userinfo .ublock .ptsinfo { color: #888; font-size: 11px; }
		#userinfo .ublock .ptsinfo .pts { font-weight: bold; }
		#footer { width: 600px; margin: 15px auto 0 auto; font-size: 10px; }
	</style>
</head>
<body>
	<div id="main">
		<h1>The trollers game <small>Dama game written in HTML5 language</small></h1>
		<div id="debug">
			<h3>Debug messages</h3>
			<div id="debugMessages"></div>
		</div>
		<canvas style="border: 1px solid black" id="canvas" width="400" height="400"></canvas>
		<div id="userinfo"></div>
	</div>
	<div id="footer">
		Developed by Andrei Rosseti and Diogo Z. Cidral
	</div>
</body>
</html>